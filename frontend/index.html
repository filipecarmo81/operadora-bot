<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Operadora KPIs</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #9CA3AF;
      --fg: #E5E7EB;
      --brand: #60A5FA;
      --brand-2: #22d3ee;
      --danger: #ef4444;
      --ok: #10b981;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      background: radial-gradient(1200px 900px at 10% 0%, rgba(34,211,238,.08), transparent 40%),
                  radial-gradient(1000px 700px at 95% 15%, rgba(96,165,250,.10), transparent 45%),
                  var(--bg);
      color: var(--fg); font: 15px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    h1 { margin: 0 0 20px; letter-spacing:.3px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
    .card {
      grid-column: span 4;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border: 1px solid var(--border);
      border-radius: 14px; padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 14px; font-size: 20px; }
    label { display: block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    .row { display: flex; gap: 10px; align-items: center; }
    input, select, button {
      outline: none; border: 1px solid var(--border); background: #0b1220; color: var(--fg);
      border-radius: 10px; padding: 11px 12px; font-size: 14px;
    }
    input::placeholder { color: #6b7280; }
    button.btn {
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      border: none; font-weight: 600; cursor: pointer;
      transition: transform .08s ease, filter .15s ease;
    }
    button.btn:hover { filter: brightness(1.08); }
    button.btn:active { transform: translateY(1px); }
    pre {
      background: #0b1220; border:1px solid var(--border);
      border-radius: 10px; padding: 12px; overflow:auto; max-height: 420px;
    }
    .err { color: var(--danger); margin-top: 8px; font-size: 13px; }
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { text-align: left; padding: 10px 8px; border-bottom:1px solid var(--border); }
    th { color: var(--muted); font-weight: 600; }
    .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }
    @media (max-width: 1200px){ .card{grid-column: span 6;} }
    @media (max-width: 700px){ .card{grid-column: span 12;} }
  </style>
</head>
<body>
  <h1>Operadora KPIs</h1>

  <div class="grid">

    <!-- Card 1 — Top Prestadores (impacto) -->
    <section class="card">
      <h2>Top Prestadores (impacto)</h2>
      <label for="top_comp">Competência (YYYY-MM)</label>
      <input id="top_comp" type="month" />

      <label for="top_n">Top N</label>
      <div class="row">
        <input id="top_n" type="number" min="1" step="1" value="10" style="width:120px" />
        <button id="btn-top" type="button" class="btn">Consultar</button>
      </div>

      <div id="err-top" class="err"></div>

      <table id="top-tbl" style="display:none">
        <thead>
          <tr><th>id_prestador</th><th>nome</th><th>score</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Card 2 — Sinistralidade -->
    <section class="card">
      <h2>Sinistralidade (última & média)</h2>
      <div class="row" style="gap:8px; margin: 6px 0 10px;">
        <button id="btn-ult" type="button" class="btn">Carregar última</button>
        <button id="btn-med" type="button" class="btn" style="background:linear-gradient(90deg,#34d399,#06b6d4)">Carregar média</button>
      </div>
      <pre id="sin-json" style="display:none"></pre>
      <div id="err-sin" class="err"></div>
      <div id="hint-sin" class="hint"></div>
    </section>

    <!-- Card 3 — Utilização -->
    <section class="card">
      <h2>Utilização — Resumo por filtros</h2>

      <label for="u_comp">Competência (YYYY-MM)</label>
      <input id="u_comp" type="month" />

      <label for="u_prod">Produto (opcional)</label>
      <input id="u_prod" placeholder="código ou nome" />

      <div class="row">
        <div style="flex:1">
          <label for="u_uf">UF (opcional)</label>
          <input id="u_uf" placeholder="SP, RJ..." />
        </div>
        <div style="flex:1">
          <label for="u_cid">Cidade (opcional)</label>
          <input id="u_cid" placeholder="São Paulo, Rio..." />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="u_sexo">Sexo (opcional)</label>
          <input id="u_sexo" placeholder="M ou F" />
        </div>
        <div style="flex:1">
          <label for="u_faixa">Faixa etária (opcional)</label>
          <input id="u_faixa" placeholder="0-18, 19-59, 60+" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btn-u" type="button" class="btn">Consultar</button>
      </div>

      <div id="err-u" class="err"></div>
      <div id="hint-u" class="hint"></div>
      <pre id="u-json" style="display:none"></pre>
    </section>

  </div>

  <div class="hint" style="margin-top:18px">
    <a href="https://operadora-bot.onrender.com/docs" target="_blank" style="color:#93c5fd; text-decoration:none;">Swagger da API</a>
  </div>

  <script>
    // ===== CONFIG =====
    const API = "https://operadora-bot.onrender.com";
    let LAST_MONTH = null;

    const $ = (id)=>document.getElementById(id);
    const show = (el, on=true)=>{ el.style.display = on ? "" : "none"; };

    function ym(input){
      const v = (input?.value || "").trim();
      return /^\d{4}-\d{2}$/.test(v) ? v : new Date().toISOString().slice(0,7);
    }
    function qs(obj){
      const p = new URLSearchParams();
      for (const [k,v] of Object.entries(obj||{})){
        if (v === undefined || v === null) continue;
        const s = String(v).trim();
        if (s) p.set(k, s);
      }
      return p.toString();
    }
    async function fetchJson(url){
      try{
        const r = await fetch(url, {mode:"cors"});
        const text = await r.text();
        if(!r.ok){
          // devolve erro com status e corpo
          throw new Error(`HTTP ${r.status} — ${text || "(sem corpo)"}`);
        }
        return text ? JSON.parse(text) : {};
      }catch(err){
        throw new Error(err?.message || "Failed to fetch");
      }
    }

    // ===== TOP PRESTADORES =====
    $("btn-top").onclick = async ()=>{
      $("err-top").textContent = "";
      const comp = ym($("top_comp"));
      const n = Math.max(1, parseInt($("top_n").value || "10", 10));
      const url = `${API}/kpi/prestador/impacto?${qs({competencia:comp, top:n})}`;
      try{
        const data = await fetchJson(url);
        const rows = data?.top || [];
        const tb = $("top-tbl").querySelector("tbody");
        tb.innerHTML = "";
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.id_prestador}</td>
            <td>${r.nome}</td>
            <td>${Number(r.score).toLocaleString("pt-BR", {maximumFractionDigits:2})}</td>`;
          tb.appendChild(tr);
        }
        $("top-tbl").style.display = rows.length ? "" : "none";
      }catch(e){
        $("top-tbl").style.display = "none";
        $("err-top").textContent = e.message;
      }
    };

    // ===== SINISTRALIDADE =====
    $("btn-ult").onclick = async ()=>{
      $("err-sin").textContent = ""; $("hint-sin").textContent = ""; show($("sin-json"), false);
      try{
        const data = await fetchJson(`${API}/kpi/sinistralidade/ultima`);
        $("sin-json").textContent = JSON.stringify(data, null, 2);
        show($("sin-json"), true);
      }catch(e){ $("err-sin").textContent = e.message; }
    };
    $("btn-med").onclick = async ()=>{
      $("err-sin").textContent = ""; $("hint-sin").textContent = ""; show($("sin-json"), false);
      try{
        const data = await fetchJson(`${API}/kpi/sinistralidade/media?janela_meses=12`);
        $("sin-json").textContent = JSON.stringify(data, null, 2);
        show($("sin-json"), true);
      }catch(e){ $("err-sin").textContent = e.message; }
    };

    // ===== UTILIZAÇÃO (com fallback e erro detalhado) =====
    $("btn-u").onclick = async ()=>{
      $("err-u").textContent = ""; $("hint-u").textContent = ""; show($("u-json"), false);

      let comp = ym($("u_comp"));
      const original = comp;

      // se usuário escolheu mês acima do último conhecido, força fallback
      if (LAST_MONTH && comp > LAST_MONTH) {
        comp = LAST_MONTH;
        $("u_comp").value = LAST_MONTH;
        $("hint-u").innerHTML = `Sem dados para <b>${original}</b>. Usei <b>${LAST_MONTH}</b>.`;
      }

      const params = {
        competencia: comp,
        produto: $("u_prod").value,
        uf: $("u_uf").value,
        cidade: $("u_cid").value,
        sexo: $("u_sexo").value,
        faixa: $("u_faixa").value
      };
      const url = `${API}/kpi/utilizacao/resumo?${qs(params)}`;

      try{
        const data = await fetchJson(url);
        $("u-json").textContent = JSON.stringify(data, null, 2);
        show($("u-json"), true);
      }catch(e){
        // última tentativa: se não tentei LAST_MONTH ainda, tenta agora e explica
        if (LAST_MONTH && original !== LAST_MONTH){
          try{
            const data2 = await fetchJson(`${API}/kpi/utilizacao/resumo?${qs({...params, competencia: LAST_MONTH})}`);
            $("u_comp").value = LAST_MONTH;
            $("hint-u").innerHTML = `Sem dados para <b>${original}</b>. Usei <b>${LAST_MONTH}</b>.`;
            $("u-json").textContent = JSON.stringify(data2, null, 2);
            show($("u-json"), true);
            return;
          }catch(_) {}
        }
        $("err-u").textContent = e.message; // mostra status e corpo se vier do backend
      }
    };

    // ===== Bootstrap: descobre LAST_MONTH e preenche tudo com ele =====
    (async function init(){
      try{
        const ult = await fetchJson(`${API}/kpi/sinistralidade/ultima`);
        LAST_MONTH = ult?.competencia || new Date().toISOString().slice(0,7);
      }catch{
        LAST_MONTH = new Date().toISOString().slice(0,7);
      }
      // preencher inputs
      ["top_comp","u_comp"].forEach(id => { const el = $(id); if (el) el.value = LAST_MONTH; });
      // disparar consultas iniciais para dar “vida” à página
      $("btn-top").click();
      $("btn-ult").click();
    })();
  </script>
</body>
</html>
